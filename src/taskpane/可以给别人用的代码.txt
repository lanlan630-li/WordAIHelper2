<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>WordAI Helper</title>
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 10px; }
        .button-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .action-button { padding: 15px; font-size: 14px; cursor: pointer; border: 1px solid #ccc; background-color: #f0f0f0; border-radius: 5px; }
        .action-button:hover { background-color: #e0e0e0; }
        .dialog { display: none; border: 1px solid #ccc; padding: 10px; margin-top: 15px; border-radius: 5px; }
        .dialog h3 { margin-top: 0; }
        .dialog textarea { width: 95%; box-sizing: border-box; }
        .dialog-buttons { margin-top: 10px; }
        .dialog-buttons button { margin-right: 5px; padding: 5px 10px; }
        #preview-area { border: 1px solid #ddd; padding: 10px; margin-top: 10px; min-height: 60px; background-color: #fafafa; white-space: pre-wrap; }
        
        /* 新增API配置区域样式 */
        .api-config { margin-bottom: 15px; padding: 10px; background-color: #f5f5f5; border-radius: 5px; }
        .api-input { width: 70%; padding: 5px; margin-right: 10px; }
    </style>
</head>
<body class="ms-font-m">
    <h1>WordAI 智能助手</h1>
    
    <!-- 新增API配置区域 -->
    <div class="api-config">
        <div>
            <label>API Key: </label>
            <input type="password" id="api-key" class="api-input" placeholder="请输入您的无问芯穹API Key">
            <button id="save-key-btn">保存</button>
        </div>
        <div id="key-status" style="margin-top: 5px; font-size: 12px; color: #666;"></div>
    </div>

    <div class="button-group">
        <button id="polish-btn" class="action-button">润色</button>
        <button id="expand-btn" class="action-button">扩写</button>
        <button id="other-btn" class="action-button">其他</button>
        <button id="translate-btn" class="action-button">翻译</button>
        <button id="explain-btn" class="action-button">解释</button>
    </div>

    <!-- 这个是对话框，默认是隐藏的 -->
    <div id="action-dialog" class="dialog">
        <h3 id="dialog-title">请输入您的指令</h3>
        <textarea id="instruction-input" rows="3" placeholder="例如：让语气更正式一些"></textarea>
        <div id="preview-area"></div>
        <div class="dialog-buttons">
            <button id="confirm-btn">确认</button>
            <button id="copy-btn">复制</button>
            <button id="cancel-btn">取消</button>
        </div>
    </div>

    <script>
        // API Key管理
        let apiKey = '';
        
        // 从本地存储加载API Key
        function loadApiKey() {
            const savedKey = localStorage.getItem('wordai_api_key');
            if (savedKey) {
                apiKey = savedKey;
                document.getElementById('api-key').value = savedKey;
                document.getElementById('key-status').innerText = 'API Key已保存';
                document.getElementById('key-status').style.color = 'green';
            } else {
                document.getElementById('key-status').innerText = '请输入API Key';
                document.getElementById('key-status').style.color = 'red';
            }
        }
        
        // 保存API Key到本地存储
        function saveApiKey() {
            const inputKey = document.getElementById('api-key').value;
            if (inputKey.trim()) {
                apiKey = inputKey;
                localStorage.setItem('wordai_api_key', inputKey);
                document.getElementById('key-status').innerText = 'API Key已保存';
                document.getElementById('key-status').style.color = 'green';
                alert('API Key已保存');
            } else {
                document.getElementById('key-status').innerText = 'API Key不能为空';
                document.getElementById('key-status').style.color = 'red';
            }
        }

        Office.onReady(function() {
            // 加载API Key
            loadApiKey();
            
            // 保存API Key按钮事件
            document.getElementById('save-key-btn').onclick = saveApiKey;
            
            // 按钮事件绑定 - 完全保持原样
            document.getElementById('polish-btn').onclick = function() { 
                if (!apiKey) { alert('请先输入API Key'); return; }
                showDialog('润色文本', '请对以下文本进行润色，使其更加流畅和专业：'); 
            };
            document.getElementById('expand-btn').onclick = function() { 
                if (!apiKey) { alert('请先输入API Key'); return; }
                showDialog('扩写文本', '请对以下文本进行扩写，增加更多细节和内容：'); 
            };
            document.getElementById('other-btn').onclick = function() { 
                if (!apiKey) { alert('请先输入API Key'); return; }
                showDialog('自定义处理', '请对以下文本进行处理：'); 
            };
            document.getElementById('translate-btn').onclick = function() { 
                if (!apiKey) { alert('请先输入API Key'); return; }
                showDialog('翻译文本', '请将以下文本翻译成中文：'); 
            };
            document.getElementById('explain-btn').onclick = function() { 
                if (!apiKey) { alert('请先输入API Key'); return; }
                showDialog('解释文本', '请解释以下文本的含义：'); 
            };
            
            // 对话框按钮事件 - 完全保持原样
            document.getElementById('confirm-btn').onclick = confirmAction;
            document.getElementById('copy-btn').onclick = copyResult;
            document.getElementById('cancel-btn').onclick = hideDialog;
            
            // 输入框变化时更新预览 - 完全保持原样
            document.getElementById('instruction-input').oninput = updatePreview;
        });

        let currentAction = '';
        let selectedText = '';

        function showDialog(title, instruction) {
            document.getElementById('dialog-title').innerText = title;
            document.getElementById('instruction-input').value = instruction;
            document.getElementById('action-dialog').style.display = 'block';
            currentAction = title;
            
            // 获取选中的文本 - 完全保持原样
            Word.run(function(context) {
                const selection = context.document.getSelection();
                context.load(selection, 'text');
                return context.sync().then(function() {
                    selectedText = selection.text;
                    updatePreview();
                });
            }).catch(function(error) {
                console.log(error);
                selectedText = '';
                updatePreview();
            });
        }

        function hideDialog() {
            document.getElementById('action-dialog').style.display = 'none';
        }

        function updatePreview() {
            const instruction = document.getElementById('instruction-input').value;
            const preview = instruction + '\n\n原文：' + (selectedText || '请先在Word中选择要处理的文本');
            document.getElementById('preview-area').innerText = preview;
        }

        // 只修改这个函数 - 其他完全不变
        async function confirmAction() {
            const instruction = document.getElementById('instruction-input').value;
            const fullPrompt = instruction + '\n\n原文：' + (selectedText || '请先在Word中选择要处理的文本');
            
            // 显示加载状态 - 保持原样
            document.getElementById('preview-area').innerText = '正在处理，请稍候...';
            
            try {
                // ===== 只修改这部分API调用 =====
                const response = await fetch('https://cloud.infini-ai.com/maas/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + apiKey  // 使用保存的API Key
                    },
                    body: JSON.stringify({
                        model: 'deepseek-v3.2-exp',
                        messages: [{ role: 'user', content: fullPrompt }],
                        temperature: 0.7
                    })
                });
                // ===== API调用部分结束 =====

                if (!response.ok) {
                    throw new Error(`API调用失败: ${response.status}`);
                }

                const data = await response.json();
                const result = data.choices[0].message.content;
                
                document.getElementById('preview-area').innerText = result;
                
            } catch (error) {
                console.error('错误:', error);
                document.getElementById('preview-area').innerText = '处理失败: ' + error.message;
            }
        }

        function copyResult() {
            const result = document.getElementById('preview-area').innerText;
            if (result && !result.includes('处理失败') && !result.includes('请稍候')) {
                navigator.clipboard.writeText(result).then(function() {
                    // 保持原样的复制成功提示
                }).catch(function(err) {
                    console.error('复制失败:', err);
                });
            }
        }
    </script>
</body>
</html>
